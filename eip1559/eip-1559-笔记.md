

# EIP‑1559 学习笔记  
**（以太坊 Gas 机制 · 数学公式 · 钱包估算 · MEV 出价）**

---

## 一、EIP‑1559 是什么

**EIP‑1559** 是以太坊在 **London 升级（2021‑08）** 中引入的新手续费机制，用 **算法定价** 取代原有的 **Gas 拍卖机制**，并引入 **ETH 燃烧（Burn）**。

### 核心目标
- 降低 Gas 费用的不确定性
- 缓解 Gas War
- 改善用户体验
- 为 ETH 引入长期通缩压力
- 为 PoS / MEV / PBS 提供稳定基础

---

## 二、手续费模型的变化

### 1. 升级前（拍卖制）

```
Fee = Gas Used × Gas Price
```

- 用户自行竞价
- 易失败、易浪费
- Gas War 严重

---

### 2. 升级后（EIP‑1559）

```
Fee = Gas Used × (Base Fee + Priority Fee)
```

新增参数：

| 参数 | 含义 | 去向 |
|---|---|---|
| Base Fee | 协议自动计算 | **直接燃烧** |
| Priority Fee | 小费 | 给区块生产者 |
| Max Fee | 用户能接受的最高 Gas | 上限保护 |

---

## 三、Base Fee 的数学机制（核心）

### 1. 关键参数

| 符号 | 含义 |
|---|---|
| \(B_n\) | 当前区块 Base Fee |
| \(B_{n+1}\) | 下一区块 Base Fee |
| \(G_{used}\) | 当前区块 Gas 使用量 |
| \(G_{target}\) | 目标 Gas（最大 Gas / 2） |
| \(d\) | 调整因子（固定为 8） |

---

### 2. Base Fee 调整公式

\[
B_{n+1}
=
B_n \times
\left(
1 +
\frac{G_{used} - G_{target}}{G_{target} \times 8}
\right)
\]

### 3. 性质

- 区块刚好达到 Target → Base Fee 不变
- 区块拥堵 → Base Fee 上涨
- 区块空闲 → Base Fee 下跌
- 单区块最大变化：±12.5%

✅ **平滑变化，防止剧烈波动**

---

## 四、弹性区块容量（Elastic Block）

- 区块最大 Gas ≈ `2 × targetGas`
- 正常维持在 target 附近
- 拥堵时短期“扩容”

➡ 缓解瞬时高峰（NFT mint、清算等）

---

## 五、交易的实际费用计算

### 1. 有效 Gas Price

\[
GasPrice_{effective}
=
\min
\big(
maxFeePerGas,\;
baseFee + maxPriorityFeePerGas
\big)
\]

### 2. 实际花费

\[
Fee = GasUsed × GasPrice_{effective}
\]

### 3. 重要结论

- Base Fee **一定会被烧毁**
- Priority Fee 才是矿工 / 验证者收入
- Max Fee 没用完的部分 **会退回**

---

## 六、源码层面的实现逻辑（以 Geth 为例）

### 1. Base Fee 计算（伪代码）

```go
delta := parentGasUsed - parentGasTarget

baseFeeDelta :=
    parentBaseFee * delta / parentGasTarget / 8

nextBaseFee :=
    parentBaseFee + baseFeeDelta
```

所有客户端必须完全一致，否则会分叉。

---

### 2. 执行顺序

1. 扣 Base Fee（Burn）
2. 支付 Priority Fee
3. 执行交易
4. 退还未使用 Gas

---

## 七、钱包如何自动估算 Gas

### 1. 估算 Gas 用量（Gas Limit）

RPC 调用：

```json
eth_estimateGas
```

- 在 EVM 中模拟执行
- 成功返回 Gas Used
- 钱包通常加 10%~30% buffer

---

### 2. 获取 Base Fee

RPC 调用：

```json
eth_feeHistory
```

返回：
- 最近区块 Base Fee
- Priority Fee 分位数

---

### 3. 估算 Priority Fee（Tip）

常见策略：

| 模式 | Priority Fee |
|---|---|
| slow | 0.5 ~ 1 gwei |
| normal | 1 ~ 2 gwei |
| fast | 2 ~ 5 gwei |
| MEV / NFT | 10+ gwei |

---

### 4. 设置 Max Fee

常见经验公式：

\[
maxFee \approx baseFee \times 2 + priorityFee
\]

原因：
- Base Fee 每区块最多上涨 12.5%
- 2× 可覆盖多区块上涨

---

### 5. 失败保护机制

如果：

```
baseFee > maxFee
```

→ 交易不会执行  
→ 不扣 Gas  
→ 仅 pending

✅ 比旧模型安全得多

---

## 八、EIP‑1559 下的 MEV 出价机制

### 1. MEV 搜索者的收益函数

设：
- \(V\)：可提取 MEV
- \(B\)：Base Fee
- \(G\)：Gas Used
- \(P\)：支付给区块生产者的价值

\[
Profit = V - (B \times G) - P
\]

✅ Base Fee 是沉没成本  
✅ 决策核心是 **P**

---

### 2. 理性出价上限

\[
P_{max} = V - (B \times G)
\]

---

### 3. 三种 MEV 出价方式

#### （1）提高 Priority Fee
- 简单
- 不稳定
- 易被前跑

#### （2）Bundle（Flashbots）
- 私下发送
- 可直接 ETH 转账
- 成功率高

#### （3）PBS（PoS 后主流）
```
Searcher → Builder → Proposer
```

- 搜索者只和 Builder 博弈
- Builder 出价区块
- Proposer 选最高收益区块

---

### 4. 为什么 Base Fee 对 MEV 不重要？

| 项目 | 是否影响 |
|---|---|
| Base Fee | ❌（固定 & Burn） |
| Priority Fee | ✅ |
| Bundle 直付 | ✅✅ |

---

## 九、EIP‑1559 的整体影响总结

### ✅ 优点
- Gas 价格可预测
- 减少 Gas War
- 改善 UX
- ETH 引入通缩逻辑
- 支撑 PoS / PBS / MEV 市场

### ⚠️ 副作用
- MEV 更集中
- Builder / Relay 中心化风险

---

## 十、一句话总结

> **EIP‑1559 用算法定价和手续费燃烧，取代了 Gas 拍卖机制，让以太坊从“猜价格”走向“可预测执行”，并重塑了 MEV 与区块生产的经济结构。**

