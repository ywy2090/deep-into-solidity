# 撮合算法详解：Price/Time 优先、Pro-Rata 与订单簿成交机制

在金融市场中，撮合算法主要分为两大类，分别对应市场的两种状态：

- **连续交易（Continuous Trading）**
- **集合竞价（Auction）**

集合竞价通常用于开盘前、收盘时等特定时段，其撮合算法种类繁多。但市场大部分时间处于**连续交易**状态，因此本文将重点介绍连续交易中常用的两类撮合算法：

- **价格/时间优先（Price/Time Priority）**，又称 **FIFO**
- **按比例分配（Pro-Rata）**

此外，还将澄清一个常见误解：**订单簿中的成交价究竟是由买单还是卖单价决定？**

---

## 1. 价格/时间优先（Price/Time Priority，FIFO）

该规则确保：**在同一价格档位上的所有订单，按提交时间先后顺序进行撮合**——先到者先得。

### 示例

假设当前订单簿（按价格和时间排序）如下：

| Id | Side | Time  | Qty | Price | Qty | Time  | Side |
|----|------|-------|-----|-------|-----|-------|------|
| #3 |      |       |     | 20.30 | 200 | 09:05 | SELL |
| #1 |      |       |     | 20.30 | 100 | 09:01 | SELL |
| #2 |      |       |     | 20.25 | 100 | 09:03 | SELL |
| #5 | BUY  | 09:08 | 200 | 20.20 |     |       |      |
| #4 | BUY  | 09:06 | 100 | 20.15 |     |       |      |
| #6 | BUY  | 09:09 | 200 | 20.15 |     |       |      |

> **排序说明**：  
>
> - 卖单按**价格从低到高**、**时间从早到晚**排序（优先级由高到低向下递减）  
> - 买单按**价格从高到低**、**时间从早到晚**排序（优先级由高到低向上递减）  
> - 最高优先级的买卖单位于订单簿“中心”附近

现在，一笔新的**限价买单**“以 20.35 买入 250 股”进入市场。由于 20.35 高于所有卖单价，该订单将立即成交，撮合顺序如下：

1. **100 股 @ 20.25**（订单 #2，全部成交）  
2. **100 股 @ 20.30**（订单 #1，全部成交）  
3. **50 股 @ 20.30**（订单 #3，部分成交）

### 撮合后订单簿状态

| Id | Side | Time  | Qty | Price | Qty | Time  | Side |
|----|------|-------|-----|-------|-----|-------|------|
| #3 |      |       |     | 20.30 | 150 | 09:05 | SELL |
| #5 | BUY  | 09:08 | 200 | 20.20 |     |       |      |
| #4 | BUY  | 09:06 | 100 | 20.15 |     |       |      |
| #6 | BUY  | 09:09 | 200 | 20.15 |     |       |      |

> ✅ **特点**：公平、透明，鼓励早期挂单，广泛用于股票、期货等传统交易所（如 NYSE、CME）。

---

## 2. 按比例分配（Pro-Rata）

该机制**忽略订单提交时间**，在同一价格档位上，**按各订单数量占该档总数量的比例分配成交份额**。

### 示例（使用相同的初始订单簿）

同样一笔“以 20.35 买入 250 股”的买单进入。

- 首先完全成交 100 股 @ 20.25（订单 #2）
- 剩余 150 股需在 20.30 档位分配：  
  - 该档总挂单量 = 100（#1） + 200（#3） = **300 股**
  - 订单 #1 占比 = 100 / 300 = 1/3 → 成交 150 × 1/3 = **50 股**
  - 订单 #3 占比 = 200 / 300 = 2/3 → 成交 150 × 2/3 = **100 股**

### 撮合后订单簿状态

| Id | Side | Time  | Qty | Price | Qty | Time  | Side |
|----|------|-------|-----|-------|-----|-------|------|
| #3 |      |       |     | 20.30 | 100 | 09:05 | SELL |
| #1 |      |       |     | 20.30 |  50 | 09:01 | SELL |
| #5 | BUY  | 09:08 | 200 | 20.20 |     |       |      |
| #4 | BUY  | 09:06 | 100 | 20.15 |     |       |      |
| #6 | BUY  | 09:09 | 200 | 20.15 |     |       |      |

> ✅ **特点**：减少“抢跑”（front-running）激励，有利于大额挂单者，常用于部分利率衍生品、能源期货等市场（如 Eurex、CME 的某些合约）。

---

## 3. 订单簿成交机制：成交价由买单还是卖单价决定？

这是一个理解市场微观结构的关键问题。

### 简短回答

订单簿中的实际成交价**总是等于某一方已挂出的价格**：  

- 当**买方主动吃单**（如提交市价买单或限价 ≥ 最优卖价），成交价 = **卖单价（Ask）**。  
- 当**卖方主动吃单**（如提交市价卖单或限价 ≤ 最优买价），成交价 = **买单价（Bid）**。

> ✅ **不存在“用 Bid 和 Ask 夹出一个中间价成交”的情况**（在连续交易的订单簿中）。

### 详细解释

#### 订单簿的基本结构

典型的订单簿分为两个部分：

- **买单（Bids）**：买方愿意买入的价格，**从高到低排序**  
- **卖单（Asks / Offers）**：卖方愿意卖出的价格，**从低到高排序**

例如：

```
Asks（卖单）:
20.30  ← 最优卖价（Best Ask）
20.35
20.40

Bids（买单）:
20.25  ← 最优买价（Best Bid）
20.20
20.15
```

买卖价差（Spread） = Best Ask − Best Bid = 20.30 − 20.25 = 0.05

#### 成交如何发生？

成交由**流动性吃单者（Taker）** 触发，与**挂单者（Maker）** 的订单匹配：

| 吃单方向 | 触发条件 | 成交价格 | 消耗的订单 |
|----------|--------|--------|----------|
| **主动买入** | 限价 ≥ Best Ask 或市价买单 | **卖单价（Ask）** | 卖单（Ask） |
| **主动卖出** | 限价 ≤ Best Bid 或市价卖单 | **买单价（Bid）** | 买单（Bid） |

**示例**：

- 用户提交“市价买入 100 股” → 立即与 20.30 的卖单成交 → **成交价 = 20.30（卖单价）**
- 用户提交“市价卖出 100 股” → 立即与 20.25 的买单成交 → **成交价 = 20.25（买单价）**

#### 关于“夹成交”的误解

“夹成交”并非标准术语，可能源于对以下情况的误解：

- **误解**：认为成交价是 (Bid + Ask) / 2 的中间价（如 20.275）  
  → ❌ 在连续交易的订单簿中，**这不会发生**。所有成交必须匹配已存在的挂单价。

- **例外**：仅在**集合竞价（Auction）** 阶段（如开盘/收盘），交易所可能计算一个**统一撮合价**，该价格可能介于某些 Bid/Ask 之间，以最大化成交量。但这属于特殊机制，**不属于连续交易订单簿的常规行为**。

### 实际意义

- **滑点分析**：市价单的成交价由挂单深度决定，吃掉多档卖单会导致平均成交价上升。
- **交易方向识别**：通过成交价与 Bid/Ask 的关系，可推断是买方还是卖方主动成交（常用于订单流分析）。
- **撮合引擎设计**：必须确保所有成交严格发生在挂单价上，不能凭空生成新价格。

> 💡 **核心原则**：在连续交易中，**价格由挂单方设定，数量由吃单方决定**。成交是“吃”已有挂单，而非“协商”新价格。

---

## 补充资源

- **CME Group** 提供了其使用的各类撮合算法列表及详细说明：[CME Matching Algorithms](https://www.cmegroup.com/)
- 更多关于订单撮合的资料，可参考 Rajeev 的相关页面（“Order matching”系列文档）。

> 💡 **总结**：  
>
> - **Price/Time 优先** 强调“先来后到”，适合高频、公平性要求高的场景。  
> - **Pro-Rata** 强调“按量分配”，可缓解订单簿踩踏，适合机构主导的市场。  
> - **成交价始终等于挂单价**，由吃单方向决定使用 Bid 还是 Ask。  
> 理解这些机制是构建撮合引擎、分析市场数据或设计交易策略的基础。
